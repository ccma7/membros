<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Carteirinha Comunidade Crist√£</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  /* Base */
  body{
      font-family:Arial,sans-serif;
      background:#f0f0f0;
      margin:0;
      padding:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
  }

  /* üîπ T√≠tulo acima da box de login (fora da caixa) */
  .titulo-app {
      font-size: 26px;
      font-weight: bold;
      color: #0097b2; /* cor j√° usada no projeto */
      margin: 10px 0 16px 0;
      text-align: center;
  }

  /* üîπ Caixa de login (mantendo cores) */
  .containerlg {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    max-width: 400px;
    width: 100%;
    text-align: center;
    margin: 10px auto 20px auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .containerlg h2 { font-size: 1.6rem; margin: 0; }

  /* Centraliza com seguran√ßa o bot√£o do Google */
  .signin-wrap { display:flex; justify-content:center; }

  /* üîπ Caixa da carteirinha (mantendo cores) */
  .container{
      background:white;
      padding:30px;
      border-radius:12px;
      box-shadow:0 5px 15px rgba(0,0,0,0.2);
      max-width:500px;
      width:100%;
      text-align:center;
      margin-bottom:20px;
  }

  /* Bot√µes (sem alterar cores) */
  button{
      padding:15px 25px;
      border:none;
      border-radius:6px;
      background:#0097b2;
      color:white;
      cursor:pointer;
      margin:5px;
      font-weight:bold;
      font-size:16px;
  }
  button:hover{background:#00758a;}

  img{
      max-width:150px;
      border-radius:50%;
      margin:10px 0;
  }

  #carteirinha{display:none;}

  /* üîπ Ajustes mobile reais (login e carteirinha em tela cheia) */
  @media (max-width: 800px) {
    body { padding: 0; }

    .containerlg {
      max-width: 100%;
      width: 100%;
      margin: 0;
      border-radius: 0;
      min-height: 100dvh; /* ocupa a tela inteira no celular */
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 40px 20px;
    }

    .titulo-app {
      font-size: 22px;
      margin: 12px 0 0 0;
      padding-top: env(safe-area-inset-top);
    }

    .container {
        width:100%;
        min-height:100dvh; /* ocupa a tela inteira no celular */
        border-radius:0;
        margin:0;
        display:flex;
        flex-direction:column;
        justify-content:center;
        padding:24px 16px;
        overflow-y:auto; /* garante rolagem se o conte√∫do passar da tela */
    }

    img { max-width:180px; }
    p { font-size:18px; margin:6px 0; }
    button { width:100%; padding:14px 0; font-size:16px; }
    h2 { font-size:24px; }
  }
</style>
</head>
<body>

  <!-- üîπ T√≠tulo fora da caixa de login -->
  <div class="titulo-app">Comunidade Crist√£</div>

  <!-- Login -->
  <div class="containerlg" id="loginContainer">
    <h2>Login com Google</h2>
    <div id="g_id_onload"
        data-client_id="865470145994-cv9p33gvuoa05kt2m9gbs3rs0vrto4db.apps.googleusercontent.com"
        data-context="signin"
        data-ux_mode="popup"
        data-login_uri=""
        data-auto_prompt="false">
    </div>
    <div class="signin-wrap">
      <div class="g_id_signin" data-type="standard"></div>
    </div>
  </div>

  <!-- Carteirinha -->
  <div class="container" id="carteirinha">
    <h2 style="color:#0097b2;font-size:26px;">Carteirinha de Membro Comunidade Crist√£</h2>
    <img id="foto" src="" alt="Foto do Membro">
    <p style="color: #0097b2; font-weight: bold;"><b>N¬∫ Cadastro:</b> <span id="idText"></span></p>
    <p><b>Nome:</b> <span id="nomeText"></span></p>
    <p><b>Data de Nascimento:</b> <span id="nascText"></span></p>
    <p><b>Endere√ßo:</b> <span id="enderecoText"></span></p>
    <p><b>Fun√ß√£o:</b> <span id="funcaoText"></span></p>
    <p><b>CPF:</b> <span id="idadeText"></span></p>
    <p><b>Email:</b> <span id="emailText"></span></p>
    <p><b>Status:</b> <span id="statusText"></span></p>
    <p style="color: #ff0000;"><b>Validade: 12/2025</b></p>
    <p style="font-size: 14px;"><b>Lei 9982/00 - Lei no 9.982, de 14 de julho de 2000</b></p>
    <p style="color: #0097b2; font-size: 16px;"><b>Bp. Presidente: Daniel Pereira da Costa</b></p>
    <img src="logo.png" style="width:80px;margin-top:10px;">
    <br>
    <button onclick="gerarPDF()">Gerar PDF</button>
    <button onclick="logout()">Sair</button>
  </div>

  <script>
  // ======= JS original (mantido) =======
  const sheetID = "17BYpWVD-AcESh227hRor6TMkOpbfw34LUOz6b-g91vw"; 
  let membroAtual = null;

  function formatarData(data){
      if(!data) return "";
      let dt;
      if(!isNaN(data)){
          dt = new Date((data - 25569) * 86400 * 1000);
      } else {
          dt = new Date(data);
      }
      if(isNaN(dt.getTime())) return data;
      const dia = String(dt.getDate()).padStart(2,'0');
      const mes = String(dt.getMonth()+1).padStart(2,'0');
      const ano = dt.getFullYear();
      return `${dia}/${mes}/${ano}`;
  }

  async function buscarTodosMembros(){
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      const rows = json.table.rows;
      return rows.map((r,i)=>({
          nome:r.c[1]?.v,
          email:r.c[2]?.v,
          funcao:r.c[3]?.v,
          idade:r.c[4]?.v,
          endereco:r.c[5]?.v,
          foto:r.c[6]?.v,
          status:r.c[7]?.v || "Ativo",
          nascimento:r.c[8]?.v || "",
          id:r.c[9]?.v || ""  
      }));
  }

  async function buscarMembro(email){
      const membros = await buscarTodosMembros();
      return membros.find(m=>m.email?.trim().toLowerCase()===email?.trim().toLowerCase());
  }

  async function handleCredentialResponse(response){
      try {
        const data = parseJwt(response.credential);
        const email = data.email;
        const nomeGoogle = data.name;
        const fotoGoogle = data.picture;

        const m = await buscarMembro(email);
        if(!m){
            alert("Voc√™ n√£o est√° cadastrado. Preencha o formul√°rio da comunidade.");
            window.location.href="https://docs.google.com/forms/d/e/1FAIpQLSdXSAlqdXIBiY8yxn3KYR3Pr7V4pbLZOrS7SyFYcO9iwh7Ucw/viewform?usp=pp_url&entry.2005620554="+encodeURIComponent(nomeGoogle)+"&entry.1045781291="+encodeURIComponent(email);
            return;
        }
        if(m.status!=="Ativo"){
            alert("Membro inativo");
            logout();
            return;
        }

        // Executa script Google Apps antes de abrir a carteirinha
        try {
            await fetch("https://script.google.com/macros/s/AKfycbwXe-cALSzrXA6xwG3JSC6yoE24YXjlIS3an5JMG0OJFN3elNXamOFi4yRHEMKuHZnbQA/exec", { mode: 'no-cors' });
            // mode no-cors para evitar bloqueio visual caso o script n√£o retorne CORS
        } catch (e) {
            console.error("Erro ao executar o script Google:", e);
            // Continua mesmo se falhar, para n√£o travar o login
        }

        // Exibe a carteirinha
        membroAtual = m;
        document.getElementById('loginContainer').style.display="none";
        document.getElementById('carteirinha').style.display="block";
        document.getElementById('idText').innerText = m.id || '';
        document.getElementById('nomeText').innerText = m.nome || '';
        document.getElementById('nascText').innerText = formatarData(m.nascimento);
        document.getElementById('enderecoText').innerText = m.endereco || '';
        document.getElementById('funcaoText').innerText = m.funcao || '';
        document.getElementById('idadeText').innerText = m.idade || '';
        document.getElementById('emailText').innerText = m.email || '';
        document.getElementById('statusText').innerText = m.status || '';
        document.getElementById('foto').src = m.foto || fotoGoogle || '';
      } catch(err){
        console.error('Falha no login:', err);
        alert('N√£o foi poss√≠vel completar o login. Tente novamente.');
      }
  }

  function logout(){
      membroAtual=null;
      document.getElementById('loginContainer').style.display="block";
      document.getElementById('carteirinha').style.display="none";
  }

  async function gerarPDF(){
      if(!membroAtual) return;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Carteirinha Comunidade Crist√£",20,20);
      doc.setFontSize(12);
      doc.text(`ID: ${membroAtual.id || ''}`,20,30);
      doc.text(`Nome: ${membroAtual.nome || ''}`,20,40);
      doc.text(`Data de Nascimento: ${formatarData(membroAtual.nascimento)}`,20,50);
      doc.text(`Endere√ßo: ${membroAtual.endereco || ''}`,20,60);
      doc.text(`Fun√ß√£o: ${membroAtual.funcao || ''}`,20,70);
      doc.text(`CPF: ${membroAtual.idade || ''}`,20,80);
      doc.text(`Email: ${membroAtual.email || ''}`,20,90);
      doc.text(`Status: ${membroAtual.status || ''}`,20,100);
      if(membroAtual.foto){
          const img = await convertImgToBase64(membroAtual.foto);
          doc.addImage(img,'JPEG',150,20,40,40);
      }
      try {
        const logo = await convertImgToBase64("logo.png");
        doc.addImage(logo,'PNG',20,110,30,30);
      } catch(e) {
        console.warn('Logo n√£o encontrada ou sem CORS liberado.');
      }
      doc.save(`${(membroAtual.nome||'membro')}_carteirinha.pdf`);
  }

  async function convertImgToBase64(url){
      const res = await fetch(url, { mode: 'cors' });
      const blob = await res.blob();
      return new Promise(resolve=>{
          const reader = new FileReader();
          reader.onloadend = ()=>resolve(reader.result);
          reader.readAsDataURL(blob);
      });
  }

  function parseJwt(token){
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
      var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(c=> '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
      return JSON.parse(jsonPayload);
  }

  window.onload=function(){
      google.accounts.id.initialize({
          client_id: "865470145994-cv9p33gvuoa05kt2m9gbs3rs0vrto4db.apps.googleusercontent.com",
          callback: handleCredentialResponse
      });
      // Render do bot√£o (largura fixa, centralizado pelo container)
      google.accounts.id.renderButton(
          document.querySelector(".g_id_signin"),
          { theme:"outline", size:"large", width: 320, locale: 'pt-BR' }
      );
      google.accounts.id.prompt();
  };
  // ======= fim JS original =======
  </script>
</body>
</html>
